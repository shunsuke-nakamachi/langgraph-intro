# LangSmith Integration（トレーシング・デバッグ）

このレッスンでは、**LangSmithを使ってLangGraphの実行過程を可視化・デバッグする方法**を学びます。

LangSmithは、LangChain/LangGraphアプリケーションの開発、テスト、評価、監視を統合的に支援するプラットフォームです。実行ログを可視化することで、デバッグやパフォーマンス分析が格段に楽になります。

## 学ぶこと

1. **LangSmithの基本設定**: アカウント作成、APIキー取得、環境変数の設定
2. **トレーシングの有効化**: 自動的に実行ログを記録する方法
3. **LangSmith UIでの確認**: 実行履歴、ノードごとの詳細、エラーの追跡
4. **デバッグの活用**: どのノードで何が起きたかを確認する方法
5. **パフォーマンス分析**: 実行時間、トークン使用量、コストの確認

## なぜ必要か

### 1. デバッグの困難さ

LangGraphアプリケーションを開発していると、以下のような問題に直面します：

- **どのノードで何が起きたか分からない**: 複数のノードが実行されると、どこで問題が起きたか特定が困難
- **LLMへの入力と出力が確認できない**: プロンプトが正しく生成されているか、レスポンスが期待通りか確認できない
- **エラーの原因が特定できない**: エラーが発生しても、どのノードで、どんな入力で発生したか分からない
- **パフォーマンスの問題が分からない**: どのノードが遅いか、どこで時間がかかっているか分からない

### 2. LangSmithの利点

- **実行過程の可視化**: どのノードがいつ実行されたか、一目で分かる
- **詳細なログ**: LLMへの入力、出力、Stateの変化が全て記録される
- **デバッグの効率化**: 問題が起きたノードを特定し、原因を調査できる
- **パフォーマンス分析**: 実行時間、トークン使用量、コストを分析できる
- **チームでの共有**: 実行ログをチームで共有し、問題を協力して解決できる

### 3. 実務での重要性

- **開発効率の向上**: デバッグ時間の大幅な短縮
- **品質の向上**: 問題を早期発見し、修正できる
- **コスト管理**: トークン使用量を監視し、コストを最適化できる
- **運用監視**: 本番環境での問題を早期発見できる

## セットアップ手順

### 1. LangSmithアカウントの作成

1. **LangSmithにアクセス**: https://smith.langchain.com/
2. **アカウント作成**: GitHubアカウントまたはメールアドレスでサインアップ（無料）
3. **APIキーの取得**: 
   - アカウント設定 → API Keys
   - 「Create API Key」をクリック
   - APIキーをコピー（後で使います）

### 2. 環境変数の設定

`.env`ファイルに以下を追加してください：

```env
# LangSmithの設定
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=your_api_key_here
LANGCHAIN_PROJECT=langgraph-practice  # プロジェクト名（任意、省略可）
```

**環境変数の説明**:

- **`LANGCHAIN_TRACING_V2=true`**: トレーシングを有効にする
- **`LANGCHAIN_API_KEY`**: LangSmithのAPIキー（必須）
- **`LANGCHAIN_PROJECT`**: プロジェクト名（省略可、デフォルトは"default"）

### 3. 動作確認

```bash
python langsmith_bot.py
```

実行すると、LangSmithに自動的に実行ログが送信されます。

## コードの解説

### 1. LangSmithの設定確認

```python
tracing_enabled = os.getenv("LANGCHAIN_TRACING_V2", "false").lower() == "true"
api_key = os.getenv("LANGCHAIN_API_KEY")
project_name = os.getenv("LANGCHAIN_PROJECT", "langgraph-practice")

if tracing_enabled and api_key:
    print(f"✅ LangSmith トレーシングが有効です")
else:
    print("⚠️  LangSmith トレーシングが無効です")
```

**ポイント**:
- 環境変数が正しく設定されているか確認
- 設定されていない場合は警告を表示

### 2. 自動トレーシング

LangSmithは、**環境変数が設定されているだけで自動的にトレーシングを開始**します。

特別なコードを書く必要はありません。通常通りLangGraphを実行するだけで、実行ログがLangSmithに送信されます。

```python
# 特別な設定は不要！通常通り実行するだけ
graph = builder.compile()

# 実行すると、自動的にLangSmithにログが送信される
async for event in graph.astream_events(initial_state, version="v1"):
    # ...
```

### 3. 実行ログの記録内容

LangSmithは以下の情報を自動的に記録します：

- **ノードの実行**: どのノードがいつ実行されたか
- **LLMへの入力**: プロンプト、メッセージ履歴
- **LLMからの出力**: レスポンス内容
- **Stateの変化**: 各ノード実行前後のState
- **実行時間**: 各ノードの実行時間
- **トークン使用量**: 入力トークン数、出力トークン数
- **エラー情報**: エラーが発生した場合の詳細

## LangSmith UIでの確認方法

### 1. LangSmith UIにアクセス

1. https://smith.langchain.com/ にアクセス
2. ログイン
3. 左側のメニューから「Projects」を選択
4. プロジェクト名（`LANGCHAIN_PROJECT`で設定した名前）をクリック

### 2. 実行履歴の確認

- **Traces**: 実行履歴の一覧が表示されます
- 各実行をクリックすると、詳細が表示されます

### 3. ノードごとの詳細確認

各ノードをクリックすると、以下が確認できます：

- **Inputs**: ノードへの入力（Stateの内容）
- **Outputs**: ノードからの出力
- **LLM Calls**: LLMへの呼び出し詳細
  - プロンプト
  - レスポンス
  - トークン使用量
  - 実行時間

### 4. エラーの追跡

エラーが発生した場合：

- エラーが発生したノードが赤く表示されます
- エラーメッセージとスタックトレースが表示されます
- エラー発生時のStateが確認できます

### 5. パフォーマンス分析

- **実行時間**: 各ノードの実行時間が表示されます
- **トークン使用量**: 入力・出力トークン数が表示されます
- **コスト**: トークン使用量からコストが計算されます

## 実務での活用例

### 1. デバッグ

**問題**: 「なぜこのノードでエラーが発生するのか？」

**解決方法**:
1. LangSmith UIでエラーが発生した実行を開く
2. エラーが発生したノードを確認
3. そのノードへの入力（State）を確認
4. LLMへのプロンプトを確認
5. 問題の原因を特定

### 2. パフォーマンス最適化

**問題**: 「処理が遅い。どこがボトルネックか？」

**解決方法**:
1. LangSmith UIで実行時間を確認
2. 各ノードの実行時間を比較
3. 遅いノードを特定
4. 最適化の対象を決定

### 3. コスト管理

**問題**: 「トークン使用量が多すぎる。どこで使われているか？」

**解決方法**:
1. LangSmith UIでトークン使用量を確認
2. 各ノードのトークン使用量を比較
3. 多いノードを特定
4. プロンプトの最適化やキャッシュの導入を検討

### 4. プロンプトの改善

**問題**: 「LLMの出力が期待通りでない。プロンプトに問題があるか？」

**解決方法**:
1. LangSmith UIでLLMへの入力（プロンプト）を確認
2. 実際の出力を確認
3. プロンプトを改善
4. 再実行して結果を比較

## 高度な使い方

### 1. カスタムトレース

特定の処理を明示的にトレースしたい場合：

```python
from langsmith import traceable

@traceable(name="custom_operation")
def custom_function(input_data):
    # この関数の実行がLangSmithに記録される
    return result
```

### 2. 評価とテスト

LangSmithでは、実行結果を評価し、テストケースとして保存することもできます。

### 3. データセットの管理

テストデータセットをLangSmithで管理し、複数の実行を比較することもできます。

## トラブルシューティング

### 1. ログが表示されない

**原因**: 環境変数が正しく設定されていない

**解決方法**:
- `.env`ファイルを確認
- 環境変数が正しく読み込まれているか確認（`python langsmith_bot.py`の最初の出力を確認）

### 2. APIキーが無効

**原因**: APIキーが間違っている、または期限切れ

**解決方法**:
- LangSmith UIで新しいAPIキーを生成
- `.env`ファイルを更新

### 3. プロジェクトが見つからない

**原因**: プロジェクト名が間違っている

**解決方法**:
- LangSmith UIでプロジェクト一覧を確認
- `.env`ファイルの`LANGCHAIN_PROJECT`を確認

## まとめ

LangSmithは、**LangGraphアプリケーションの開発と運用を大幅に改善する強力なツール**です。

- **デバッグの効率化**: 問題を迅速に特定し、解決できる
- **パフォーマンス分析**: ボトルネックを特定し、最適化できる
- **コスト管理**: トークン使用量を監視し、コストを最適化できる
- **チームでの共有**: 実行ログを共有し、協力して問題を解決できる

実務では、LangSmithなしで開発するのは困難です。必ず設定して、開発効率を向上させましょう。

## 参考リンク

- **LangSmith公式サイト**: https://smith.langchain.com/
- **LangSmithドキュメント**: https://docs.smith.langchain.com/
- **APIキーの取得**: https://smith.langchain.com/settings

